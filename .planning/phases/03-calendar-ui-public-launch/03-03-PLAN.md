---
phase: 03-calendar-ui-public-launch
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - client/src/components/FilterBar.tsx
  - client/src/hooks/useFilterState.ts
  - client/src/hooks/useDebounce.ts
  - client/src/App.tsx
  - client/src/components/EventList.tsx
autonomous: true
requirements: [DISP-01, DISP-02, DISP-03, DISP-04, DISP-05, INTG-01, INTG-02]

must_haves:
  truths:
    - "User can filter events by genre and see results update immediately"
    - "User can filter events by venue and see results update immediately"
    - "User can filter events by date range and see results update immediately"
    - "User can search events by artist name and see results after brief delay"
    - "User can search events by event name and see results after brief delay"
    - "Filter state persists in URL (shareable links work)"
    - "User can clear all filters with one click"
  artifacts:
    - path: "client/src/components/FilterBar.tsx"
      provides: "Filter UI with genre, venue, date range, search inputs"
      min_lines: 80
    - path: "client/src/hooks/useFilterState.ts"
      provides: "URL-based filter state management"
      exports: ["useFilterState"]
    - path: "client/src/hooks/useDebounce.ts"
      provides: "Debounced value hook for search inputs"
      exports: ["useDebounce"]
  key_links:
    - from: "client/src/components/FilterBar.tsx"
      to: "client/src/hooks/useFilterState.ts"
      via: "useFilterState hook call"
      pattern: "useFilterState\\(\\)"
    - from: "client/src/components/FilterBar.tsx"
      to: "client/src/hooks/useDebounce.ts"
      via: "useDebounce for search inputs"
      pattern: "useDebounce\\("
    - from: "client/src/components/EventList.tsx"
      to: "client/src/hooks/useFilterState.ts"
      via: "Read filters from URL state"
      pattern: "useFilterState\\(\\)"
---

<objective>
Add comprehensive filtering UI with URL state management and debounced search.

Purpose: Enable users to filter events by genre, venue, date range, and search terms with immediate visual feedback and shareable URLs.
Output: Fully functional filter bar that updates URL parameters, triggers API calls, and provides responsive search experience.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calendar-ui-public-launch/03-RESEARCH.md
@.planning/phases/03-calendar-ui-public-launch/03-01-SUMMARY.md
@.planning/phases/02-api-layer-performance/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create URL-based filter state management hooks</name>
  <files>
    client/src/hooks/useFilterState.ts
    client/src/hooks/useDebounce.ts
  </files>
  <action>
Create `client/src/hooks/useFilterState.ts`:

Import:
- `useSearchParams` from 'react-router-dom'
- `EventFilters` type from '@/types/events'

Export `useFilterState()` hook:

1. Call `const [searchParams, setSearchParams] = useSearchParams()`

2. Build filters object from URL params:
```typescript
const filters: EventFilters = {
  genre: searchParams.get('genre') || undefined,
  venue: searchParams.get('venue') || undefined,
  dateFrom: searchParams.get('dateFrom') || undefined,
  dateTo: searchParams.get('dateTo') || undefined,
  artistSearch: searchParams.get('artistSearch') || undefined,
  eventSearch: searchParams.get('eventSearch') || undefined,
  // cursor and limit handled by useEvents, not exposed to filters
};
```

3. Create `updateFilters` function:
```typescript
const updateFilters = (updates: Partial<EventFilters>) => {
  const newParams = new URLSearchParams(searchParams);

  Object.entries(updates).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      newParams.set(key, String(value));
    } else {
      newParams.delete(key);
    }
  });

  setSearchParams(newParams);
};
```

4. Return `{ filters, updateFilters }`

Pattern: URL as single source of truth. Setting param triggers React Router state update, which triggers re-render, which triggers TanStack Query with new key, which fetches filtered data. URL changes are shareable and bookmark-able.

Create `client/src/hooks/useDebounce.ts`:

Export `useDebounce<T>(value: T, delay: number): T` hook:

1. Create state: `const [debouncedValue, setDebouncedValue] = useState(value)`

2. useEffect with value and delay dependencies:
   - Set timeout to update debouncedValue after delay
   - Return cleanup function that clears timeout

3. Return debouncedValue

Pattern: Immediate state updates (input value) separate from debounced state (API trigger). Provides responsive UI without overwhelming API. 300-500ms delay is sweet spot for search UX.
  </action>
  <verify>
Create test file `client/src/test-filter-hooks.tsx`:
```typescript
import { useFilterState } from './hooks/useFilterState';
import { useDebounce } from './hooks/useDebounce';
import { useState } from 'react';

function TestComponent() {
  const { filters, updateFilters } = useFilterState();
  const [search, setSearch] = useState('');
  const debouncedSearch = useDebounce(search, 300);

  console.log('Filters:', filters);
  console.log('Search:', search, 'Debounced:', debouncedSearch);

  return (
    <div>
      <button onClick={() => updateFilters({ genre: 'Rock' })}>
        Set Rock
      </button>
      <input
        value={search}
        onChange={(e) => setSearch(e.target.value)}
      />
    </div>
  );
}
```

Temporarily add TestComponent to App.tsx.

Manual test:
- Click "Set Rock" - URL should update to "?genre=Rock"
- Type in input - console should show immediate search value, debounced value updates after 300ms
- Remove TestComponent after verification

Alternatively, verify TypeScript compilation:
```bash
cd client
npx tsc --noEmit
```

Should compile without errors.
  </verify>
  <done>
- useFilterState hook reads/writes URL search params
- updateFilters function adds, updates, or removes params correctly
- Undefined/null/empty string values remove params from URL
- useDebounce hook delays value updates by specified milliseconds
- Cleanup function in useDebounce prevents memory leaks
- Both hooks have correct TypeScript types
  </done>
</task>

<task type="auto">
  <name>Task 2: Build FilterBar component with all filter types</name>
  <files>
    client/src/components/FilterBar.tsx
  </files>
  <action>
Create `client/src/components/FilterBar.tsx`:

Import:
- `useFilterState` from '@/hooks/useFilterState'
- `useDebounce` from '@/hooks/useDebounce'
- `useState` from 'react'

Component structure:

1. **Hook calls:**
   - `const { filters, updateFilters } = useFilterState()`
   - `const [artistInput, setArtistInput] = useState(filters.artistSearch || '')`
   - `const [eventInput, setEventInput] = useState(filters.eventSearch || '')`
   - `const debouncedArtist = useDebounce(artistInput, 300)`
   - `const debouncedEvent = useDebounce(eventInput, 300)`

2. **Effect to sync debounced values to URL:**
```typescript
useEffect(() => {
  updateFilters({ artistSearch: debouncedArtist });
}, [debouncedArtist]);

useEffect(() => {
  updateFilters({ eventSearch: debouncedEvent });
}, [debouncedEvent]);
```

3. **Container:** Sticky sidebar on desktop, top bar on mobile
   - Mobile: `flex flex-col gap-4 p-4 bg-white border border-gray-200 rounded-lg`
   - Desktop: `lg:sticky lg:top-4` to stick during scroll

4. **Title:** "Filters" heading (text-lg font-semibold)

5. **Genre select:**
   - Label: "Genre"
   - `<select>` with options:
     - "All Genres" (value="")
     - Rock, Pop, Electronic, Jazz, Hip Hop, Metal, Indie, Folk, Classical, World, Other
   - value: `filters.genre || ''`
   - onChange: `updateFilters({ genre: e.target.value || undefined })`

6. **Venue select:**
   - Label: "Venue"
   - `<select>` with options based on Phase 1 priority venues:
     - "All Venues" (value="")
     - Kollektivet Livet, Slaktkyrkan, Hus 7, Fasching, Nalen, Fylkingen, Slakthuset, Fållan, Landet, Mosebacke, Kägelbanan, Pet Sounds, Debaser
   - value: `filters.venue || ''`
   - onChange: `updateFilters({ venue: e.target.value || undefined })`

7. **Date range inputs:**
   - Label: "Date From"
   - `<input type="date">` with value: `filters.dateFrom?.split('T')[0] || ''`
   - onChange: converts to ISO datetime and calls updateFilters
   - Label: "Date To"
   - `<input type="date">` with value: `filters.dateTo?.split('T')[0] || ''`
   - onChange: converts to ISO datetime and calls updateFilters

8. **Artist search:**
   - Label: "Search Artists"
   - `<input type="text">` with value: `artistInput`
   - onChange: `setArtistInput(e.target.value)` (immediate)
   - placeholder: "Artist name..."

9. **Event search:**
   - Label: "Search Events"
   - `<input type="text">` with value: `eventInput`
   - onChange: `setEventInput(e.target.value)` (immediate)
   - placeholder: "Event name..."

10. **Clear filters button:**
    - Gray button at bottom
    - onClick: clears all filters and resets input states
    - Text: "Clear All Filters"

Styling:
- All inputs: Tailwind form classes (px-3 py-2 border rounded focus:ring)
- Labels: text-sm font-medium text-gray-700
- Mobile-first: Full width inputs
- Desktop: Fixed width sidebar (w-64)

Pattern: Separate immediate input state (artistInput, eventInput) from debounced state. Input feels instant, API calls are throttled. Genre/venue/date update immediately (no debounce needed for dropdowns/date pickers).
  </action>
  <verify>
Start dev server and visit http://localhost:3000:

1. **Genre filter:**
   - Select "Rock" - URL updates to ?genre=Rock
   - Event list filters to rock events
   - Select "All Genres" - URL clears genre param, shows all events

2. **Venue filter:**
   - Select "Fasching" - URL updates to ?venue=Fasching
   - Event list filters to Fasching events
   - Works correctly with normalized venue names

3. **Date range:**
   - Set "Date From" to tomorrow - events filter to future dates
   - Set "Date To" to 1 week out - events filter to range
   - Clear dates - shows all events again

4. **Artist search:**
   - Type "The" - input updates immediately
   - After 300ms, URL updates to ?artistSearch=The
   - Event list filters to artists matching "The"
   - Continue typing "Beatles" - input responsive, API calls debounced

5. **Event search:**
   - Type event name - same debounced behavior as artist search
   - Results filter correctly

6. **Combined filters:**
   - Set genre=Rock AND venue=Fasching - both apply
   - URL shows both params: ?genre=Rock&venue=Fasching
   - Event list shows only Rock events at Fasching

7. **Clear button:**
   - Set multiple filters
   - Click "Clear All Filters"
   - URL clears all params
   - Input fields reset to empty
   - Event list shows all events

8. **URL sharing:**
   - Set filters to create URL like ?genre=Jazz&venue=Nalen
   - Copy URL
   - Open in new tab/incognito - filters pre-applied correctly

9. **Responsive:**
   - Mobile (320px): Filter bar at top, full width
   - Desktop (1024px+): Filter bar becomes sticky sidebar on left

Open DevTools Network tab:
- Genre/venue changes trigger immediate API call
- Artist/event search triggers API call only after 300ms of no typing
- Verify debouncing works (rapid typing = single API call after pause)
  </verify>
  <done>
- FilterBar component renders all filter types
- Genre dropdown with 11+ genre options
- Venue dropdown with 13+ venue options
- Date range pickers for dateFrom/dateTo
- Artist search input with debouncing
- Event search input with debouncing
- Clear all filters button
- URL updates correctly for all filter changes
- Debouncing works (search inputs wait 300ms before updating URL)
- Responsive design (mobile top bar, desktop sticky sidebar)
- All Tailwind styles applied correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate FilterBar with EventList and finalize layout</name>
  <files>
    client/src/App.tsx
    client/src/components/EventList.tsx
  </files>
  <action>
Update `client/src/components/EventList.tsx`:

1. Import `useFilterState` hook
2. Call `const { filters } = useFilterState()` at top of component
3. Pass `filters` to `useEvents(filters)` instead of empty object
4. Update empty state message to mention filters:
   - "No events found"
   - "Try adjusting your filters or date range"

No other changes needed - TanStack Query will automatically refetch when filters (in query key) change.

Update `client/src/App.tsx`:

1. Import FilterBar component
2. Update layout to include FilterBar:

```tsx
<div className="min-h-screen bg-gray-50">
  <header className="bg-white border-b border-gray-200 p-4">
    <h1 className="text-2xl font-bold text-gray-900">
      Stockholm Music Events
    </h1>
    <p className="text-sm text-gray-600 mt-1">
      All times in Stockholm time (CET/CEST)
    </p>
  </header>

  <div className="container mx-auto px-4 py-6">
    <div className="flex flex-col lg:flex-row gap-6">
      <aside className="lg:w-64 flex-shrink-0">
        <FilterBar />
      </aside>

      <main className="flex-1 min-w-0">
        <EventList />
      </main>
    </div>
  </div>
</div>
```

Layout pattern:
- Mobile (< 1024px): FilterBar stacks above EventList
- Desktop (≥ 1024px): FilterBar sidebar on left (w-64), EventList takes remaining space
- Container max-width for readability on ultra-wide screens
- Padding and gaps for visual breathing room
- Header with app title and timezone notice

Pattern: Classic sidebar + main content layout. FilterBar sticky on desktop for easy access while scrolling events. Mobile-first stacking for small screens.
  </action>
  <verify>
Start dev server and visit http://localhost:3000:

1. **Layout:**
   - Header visible at top with app title
   - Timezone notice displays: "All times in Stockholm time (CET/CEST)"
   - FilterBar on left (desktop) or top (mobile)
   - EventList fills remaining space

2. **Filter integration:**
   - Change any filter - EventList immediately updates
   - URL changes - EventList refetches with new filters
   - TanStack Query DevTools shows query key updating with filters

3. **Visual polish:**
   - Proper spacing between header, sidebar, and main content
   - No layout shift when events load
   - Comfortable reading width on desktop (not full-screen wide)

4. **End-to-end flow:**
   - Load page (no filters) - shows all events
   - Select genre - filters apply
   - Add venue filter - further narrows results
   - Type search - debounced, results update
   - Clear filters - returns to all events
   - Scroll events - sidebar stays visible (desktop)

5. **Responsive:**
   - Mobile (320px): Vertical stack, no horizontal scroll
   - Tablet (768px): Same vertical stack
   - Desktop (1024px+): Sidebar layout kicks in
   - Ultra-wide (1920px+): Content centered with max-width

6. **Browser back/forward:**
   - Apply filters
   - Click browser back - filters revert, events update
   - Click forward - filters reapply, events update
   - URL state = source of truth

Open DevTools:
- Console: No errors
- Network: API calls include correct filter params
- Query key in React Query DevTools updates with filters
  </verify>
  <done>
- FilterBar integrated into App layout
- EventList reads filters from useFilterState hook
- EventList passes filters to useEvents hook
- TanStack Query refetches automatically when filters change
- Layout responsive from mobile to desktop
- Header displays app title and timezone notice
- Sidebar sticky on desktop for easy access
- Empty state message references filters
- Browser navigation (back/forward) works correctly with URL state
- All visual polish applied with Tailwind
  </done>
</task>

</tasks>

<verification>
Comprehensive end-to-end testing:

**Filter functionality:**
- [ ] Genre filter updates URL and results immediately
- [ ] Venue filter updates URL and results immediately
- [ ] Date range filters update URL and results immediately
- [ ] Artist search debounces (300ms delay after typing stops)
- [ ] Event search debounces (300ms delay after typing stops)
- [ ] Combined filters work (genre + venue + search)
- [ ] Clear button removes all filters and resets UI

**URL state management:**
- [ ] Filters persist in URL (e.g., ?genre=Rock&venue=Nalen)
- [ ] Copy/paste URL in new tab - filters pre-applied
- [ ] Share URL with someone - they see same filtered results
- [ ] Browser back/forward navigation works correctly

**Performance:**
- [ ] No API call spam during rapid typing (debouncing works)
- [ ] Filter changes trigger single API call
- [ ] TanStack Query cache prevents duplicate fetches
- [ ] Smooth transitions between filtered states

**Responsive design:**
- [ ] 320px (mobile): Filter bar above list, vertical layout
- [ ] 768px (tablet): Same vertical layout, comfortable spacing
- [ ] 1024px+ (desktop): Sidebar + main content layout
- [ ] Sidebar sticky during scroll (desktop only)

**User experience:**
- [ ] Search inputs feel responsive (immediate visual feedback)
- [ ] Results update smoothly (no jarring transitions)
- [ ] Loading states visible during refetch
- [ ] Empty state helpful when no results match filters
- [ ] Timezone notice visible in header

**Accessibility:**
- [ ] All inputs have labels
- [ ] Tab through filter controls - logical order
- [ ] Enter key works in search inputs
- [ ] Screen reader announces filter changes

**Integration with Plans 01-02:**
- [ ] EventCard styling preserved
- [ ] Infinite scroll works with filters
- [ ] Stockholm timezone formatting maintained
- [ ] Ticket links still functional

**All Phase 3 requirements validated:**
- [ ] DISP-01: Chronological list view ✓
- [ ] DISP-02: Event details displayed ✓
- [ ] DISP-03: Ticket availability shown ✓
- [ ] DISP-04: Mobile-responsive ✓
- [ ] DISP-05: Stockholm timezone ✓
- [ ] INTG-01: Click through to platform ✓
- [ ] INTG-02: Deep links ✓
</verification>

<success_criteria>
Phase complete when:
- [ ] FilterBar component implemented with all filter types
- [ ] URL-based state management working (useFilterState hook)
- [ ] Debounced search implemented (useDebounce hook)
- [ ] Genre, venue, date range filters functional
- [ ] Artist and event search functional with debouncing
- [ ] Clear all filters button works
- [ ] Filter changes trigger API refetch via TanStack Query
- [ ] URL parameters shareable and bookmark-able
- [ ] Browser navigation (back/forward) works correctly
- [ ] Layout responsive from mobile to desktop
- [ ] Sidebar sticky on desktop during scroll
- [ ] All Phase 3 requirements (DISP-01 through INTG-02) validated
- [ ] No TypeScript or console errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar-ui-public-launch/03-03-SUMMARY.md` following the summary template.
</output>
