---
phase: 04-crawler-expansion-coverage-enhancement
plan: 02
type: execute
wave: 2
depends_on: []
files_modified:
  - src/crawlers/tickster-api-client.ts
  - src/crawlers/tickster.ts
  - src/normalization/transformers.ts
  - src/config/env.ts
autonomous: true
requirements: []

user_setup:
  - service: tickster
    why: "Event ticketing API integration"
    env_vars:
      - name: TICKSTER_API_KEY
        source: "Tickster Developer Portal (pending key acquisition)"
    dashboard_config: []

must_haves:
  truths:
    - "Tickster API client successfully authenticates and fetches Stockholm events"
    - "Tickster events transform to normalized schema matching database requirements"
    - "Crawler handles pagination and rate limiting gracefully"
  artifacts:
    - path: "src/crawlers/tickster-api-client.ts"
      provides: "Tickster API client with authentication and event search"
      exports: ["TicksterClient"]
      min_lines: 80
    - path: "src/crawlers/tickster.ts"
      provides: "Tickster crawler with 12-month window and pagination"
      exports: ["crawlTickster", "CrawlResult"]
      min_lines: 60
    - path: "src/normalization/transformers.ts"
      provides: "transformTicksterEvent function"
      exports: ["transformTicksterEvent"]
    - path: "src/config/env.ts"
      provides: "TICKSTER_API_KEY config"
      contains: "TICKSTER_API_KEY"
  key_links:
    - from: "src/crawlers/tickster.ts"
      to: "src/crawlers/tickster-api-client.ts"
      via: "TicksterClient instantiation with API key"
      pattern: "new TicksterClient\\(config\\.TICKSTER_API_KEY\\)"
    - from: "src/crawlers/tickster.ts"
      to: "src/normalization/transformers.ts"
      via: "transformTicksterEvent call on each event"
      pattern: "transformTicksterEvent\\(rawEvent\\)"
    - from: "Tickster API response"
      to: "database NewEvent schema"
      via: "transformation and validation pipeline"
      pattern: "transformTicksterEvent.*upsertEvent"
---

<objective>
Integrate Tickster API to expand event coverage by fetching Stockholm music events from a major Swedish ticketing platform.

Purpose: Increases comprehensive coverage after restoring existing crawlers (per user decision: "APIs early in phase"). Tickster likely has good Stockholm venue coverage complementing existing platforms.
Output: Working Tickster API integration with client, crawler, and transformer following Ticketmaster pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-crawler-expansion-coverage-enhancement/04-CONTEXT.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-01-SUMMARY.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-02-SUMMARY.md
@src/crawlers/ticketmaster-api-client.ts
@src/crawlers/ticketmaster.ts
@src/normalization/transformers.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Create Tickster API client</name>
  <files>
    src/crawlers/tickster-api-client.ts
    src/config/env.ts
  </files>
  <action>
    Create Tickster API client following the Ticketmaster client pattern (ticketmaster-api-client.ts).

    Requirements:
    1. Class TicksterClient with constructor accepting API key
    2. Method searchEvents accepting filters (city, date range, genre/category)
    3. Rate limiting logic (determine Tickster's rate limits during implementation)
    4. Quota tracking (requests used/total/percentUsed)
    5. Pagination support (page, size parameters)
    6. Error handling for 401, 403, 429, 500 status codes
    7. Type definitions for API response structure

    Add TICKSTER_API_KEY to src/config/env.ts validation schema and export. Use dotenv pattern already established.

    Note: If Tickster API documentation is inaccessible, use reasonable defaults based on common ticketing API patterns (RESTful JSON endpoints, OAuth/API key auth, pagination via page/limit params). Document assumptions in code comments for future refinement.
  </action>
  <verify>
    TypeScript compiles without errors: `npm run build`
    Client instantiation works: `node -e "import('./src/crawlers/tickster-api-client.ts').then(m => console.log(new m.TicksterClient('test-key')))"`
  </verify>
  <done>
    TicksterClient class exists with searchEvents method, rate limiting, and quota tracking. TICKSTER_API_KEY configured in env.ts.
  </done>
</task>

<task type="auto">
  <name>Create Tickster crawler and transformer</name>
  <files>
    src/crawlers/tickster.ts
    src/normalization/transformers.ts
  </files>
  <action>
    Create Tickster crawler following the Ticketmaster crawler pattern (ticketmaster.ts).

    Crawler requirements (src/crawlers/tickster.ts):
    1. Export async function crawlTickster(): Promise<CrawlResult>
    2. Calculate 12-month rolling window (startDate = now, endDate = now+12months)
    3. Filter for Stockholm + Music events
    4. Pagination loop fetching all pages
    5. Progress logging every 10 pages
    6. Call transformTicksterEvent for normalization
    7. Call upsertEvent for database storage
    8. Return success/failed counts
    9. Graceful error handling (individual event failures don't stop crawl)

    Transformer requirements (add to src/normalization/transformers.ts):
    1. Export function transformTicksterEvent(rawEvent: any) accepting Tickster API event object
    2. Extract: name, artist, venue, date, genre, ticketUrl, price
    3. Apply venue normalization (existing venue-mappings.ts)
    4. Apply genre normalization (existing genre-mappings.ts)
    5. Validate via EventSchema.safeParse (existing pattern)
    6. Return success/errors structure matching other transformers

    Follow existing transformer patterns for consistency. Use 'Tickster' as platform value in ticket URLs.
  </action>
  <verify>
    TypeScript compiles: `npm run build`
    Transformer unit test: `node -e "import('./src/normalization/transformers.ts').then(m => console.log(m.transformTicksterEvent({name: 'Test', date: '2026-03-01T20:00:00Z'})))"`
    Crawler dry run (will fail without API key, but code should load): `node -e "import('./src/crawlers/tickster.ts').then(m => console.log('Loaded'))"`
  </verify>
  <done>
    crawlTickster function exists and follows established crawler pattern. transformTicksterEvent function normalizes Tickster events to database schema. Both integrate with existing infrastructure (upsertEvent, EventSchema).
  </done>
</task>

</tasks>

<verification>
After user provides TICKSTER_API_KEY in .env:
```bash
node -e "import('./src/crawlers/tickster.ts').then(m => m.crawlTickster())"
```

Should successfully fetch and store Tickster events for Stockholm music within 12-month window. Check database for new events with platform='Tickster' in ticket URLs.
</verification>

<success_criteria>
1. TicksterClient authenticates and fetches events from Tickster API
2. Crawler handles pagination and fetches all available Stockholm music events
3. Transformer normalizes Tickster events to database schema
4. Events save to database via upsertEvent
5. Rate limiting prevents API quota exhaustion
6. Error handling gracefully continues on individual event failures
7. Integration follows existing patterns (Ticketmaster) for maintainability
</success_criteria>

<output>
After completion, create `.planning/phases/04-crawler-expansion-coverage-enhancement/04-02-SUMMARY.md`

Note: User must provide TICKSTER_API_KEY before crawler can be tested with live API.
</output>
