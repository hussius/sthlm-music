---
phase: 04-crawler-expansion-coverage-enhancement
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - crawl-rival.js
  - crawl-underbron-fixed.js
  - crawl-all.js
  - client/src/components/FilterBar.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Rival crawler extracts events from rival.se Bootstrap carousel and saves to database"
    - "Under Bron crawler is fixed and re-enabled in crawl-all.js"
    - "Both venues appear in FilterBar dropdown"
  artifacts:
    - path: "crawl-rival.js"
      provides: "Rival hotel/venue crawler parsing Bootstrap carousel #upcoming .carousel-item"
    - path: "crawl-underbron-fixed.js"
      provides: "Fixed Under Bron crawler with improved date/event extraction"
  key_links:
    - from: "crawl-rival.js"
      to: "https://www.rival.se"
      via: "fetch + cheerio, #upcoming .carousel-item h3 for title, p for date"
    - from: "crawl-underbron-fixed.js"
      to: "https://www.underbron.com/?view=program"
      via: "fetch + cheerio, improved selector strategy over broken crawl-underbron.js"
---

<objective>
Add Rival venue crawler (Hotel Rival on Södermalm — 735-seat salon hosting concerts and comedy).
Fix the disabled Under Bron crawler (club venue, currently commented out in crawl-all.js due to
broken parsing). Both use the plain Node.js ESM fetch+Cheerio pattern.

Purpose: Rival adds diverse programming (music, comedy, theater). Under Bron is a key electronic
music venue that was previously attempted but parsing broke.

Output: crawl-rival.js, crawl-underbron-fixed.js, wired into crawl-all.js and FilterBar.tsx
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@crawl-all.js
@crawl-underbron.js
@crawl-nalen.js
@client/src/components/FilterBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rival venue crawler</name>
  <files>crawl-rival.js</files>
  <action>
    Create crawl-rival.js for Hotel Rival (www.rival.se) on Södermalm.

    URL: https://www.rival.se
    The page uses Bootstrap carousel structure. Events are in #upcoming .carousel-item elements.

    Selector strategy:
    - Container: $('#upcoming .carousel-item') or $('.carousel-item')
    - Title: find h3 within each carousel-item → event name
    - Date/description: find p elements within carousel-item → look for date pattern
    - Link: find a element with href starting with '/' or containing 'rival.se' → construct full URL

    Date parsing: Rival uses Swedish date formats in descriptions. Look for patterns:
    - "19 feb" / "19 februari" / "Feb 19" style dates in the h3 or p text
    - Extract using regex: /(\d{1,2})\s+(\w+)/ for "DD MonthName"
    - Swedish months: jan=0, feb=1, mar=2, apr=3, maj=4, jun=5, jul=6, aug=7, sep=8, okt=9, nov=10, dec=11
    - Also handle English: jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec
    - If no date found in the description p tag, check the h3 text itself for date patterns
    - Default time: 19:00 (Rival's typical show start time)
    - Default year: current year, if month appears to be in the past roll to next year

    For events with no extractable date: skip them (log a warning, don't fail).

    Build the event object:
    - name: title text (strip date if it appears in the title)
    - artist: same as name
    - venue: 'Rival'
    - date: parsed Date object
    - time: extracted or '19:00'
    - genre: 'other'
    - ticketSources: [{ platform: 'venue-direct', url: eventUrl or 'https://www.rival.se', addedAt: new Date().toISOString() }]
    - sourceId: `rival-${name.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 60)}-${YYYY-MM-DD}`
    - sourcePlatform: 'venue-direct'

    Skip past events. Upsert with standard onConflictDoUpdate pattern.
    Follow exact structure as crawl-nalen.js (dotenv, cheerio, postgres, drizzle, try/catch, client.end, process.exit).
  </action>
  <verify>node /Users/hussmikael/agents-hackathon/crawl-rival.js 2>&1 | tail -5</verify>
  <done>crawl-rival.js runs without crashing. Returns >0 events from rival.se.</done>
</task>

<task type="auto">
  <name>Task 2: Fix and replace Under Bron crawler</name>
  <files>crawl-underbron-fixed.js</files>
  <action>
    The existing crawl-underbron.js is disabled in crawl-all.js with comment "// Under Bron disabled - parsing is broken".
    Create crawl-underbron-fixed.js as a replacement with improved parsing.

    URL: https://www.underbron.com/?view=program
    Under Bron is a club/nightlife venue. The existing crawl-underbron.js uses a generic
    element traversal approach that was too fragile. The page shows events with dates in
    "DD/M" format (e.g. "27/2") and pricing text.

    Improved strategy for crawl-underbron-fixed.js:
    1. Fetch the page HTML
    2. Load with Cheerio
    3. Look for elements containing date pattern /^\d{1,2}\/\d{1,2}$/ (e.g. "27/2", "28/2")
       using $('*').filter() — these are the date markers
    4. For each date marker element:
       - Parse the date using the parseUnderBronDate logic from crawl-underbron.js (copy it)
       - Search the parent container for an event name:
         a. Try: parent.find('img').attr('alt') — image alt often has artist name
         b. Try: parent.find('h1, h2, h3, h4, strong').first().text().trim()
         c. Try: find the nearest sibling or cousin element with text > 3 chars
            that isn't a price (not matching /\d+\s*sek|\d+-\d+\s/i)
       - Build minimal event with name and date
    5. Deduplicate by (name + date) in a Set before saving
    6. Accept 0 events as non-fatal (club nights may not always be listed far in advance)

    Event object:
    - name: extracted or 'Under Bron Event' fallback
    - artist: same as name
    - venue: 'Under Bron'
    - date: parsed Date (default time 22:00 for club events)
    - time: '22:00'
    - genre: 'electronic'
    - ticketSources: [{ platform: 'venue-direct', url: 'https://www.underbron.com', addedAt: ... }]
    - sourceId: `underbron-${name.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0,60)}-${YYYY-MM-DD}`
    - sourcePlatform: 'venue-direct'

    Follow exact structure as crawl-nalen.js.
    Note: RA (Resident Advisor) integration is separate (crawl-underbron-ra.js exists).
    This crawler is for the venue website directly.
  </action>
  <verify>node /Users/hussmikael/agents-hackathon/crawl-underbron-fixed.js 2>&1 | tail -5</verify>
  <done>crawl-underbron-fixed.js runs without crashing. Exit code 0 whether or not events found.</done>
</task>

<task type="auto">
  <name>Task 3: Wire both crawlers into crawl-all.js and FilterBar</name>
  <files>crawl-all.js, client/src/components/FilterBar.tsx</files>
  <action>
    In crawl-all.js:
    1. Add after the B-K entry (or after Fredagsmangel if 04-03 not yet run):
       { name: 'Rival', file: './crawl-rival.js' }
    2. Replace the disabled Under Bron comment block with:
       { name: 'Under Bron', file: './crawl-underbron-fixed.js' }
       (Remove the old commented-out underbron entry)

    In client/src/components/FilterBar.tsx: Add to the venue select dropdown:
    - <option value="Rival">Rival</option>
    - <option value="Under Bron">Under Bron</option>
    (Under Bron may already be present from the original crawler — check first, add only if missing)
  </action>
  <verify>grep -n "Rival\|Under Bron" /Users/hussmikael/agents-hackathon/crawl-all.js /Users/hussmikael/agents-hackathon/client/src/components/FilterBar.tsx</verify>
  <done>Rival appears in crawl-all.js and FilterBar. Under Bron re-enabled in crawl-all.js (using fixed version) and present in FilterBar.</done>
</task>

</tasks>

<verification>
1. node crawl-rival.js exits code 0, reports >0 events
2. node crawl-underbron-fixed.js exits code 0 (events or graceful 0-event handling)
3. Both venues wired in crawl-all.js and FilterBar
4. The old disabled Under Bron comment removed from crawl-all.js
</verification>

<success_criteria>
1. crawl-rival.js saves >0 events from rival.se
2. crawl-underbron-fixed.js runs without crashing (0 events acceptable)
3. Both venues in crawl-all.js and FilterBar dropdown
4. Under Bron re-enabled (disabled comment removed from crawl-all.js)
</success_criteria>

<output>
After completion, create `.planning/phases/04-crawler-expansion-coverage-enhancement/04-04-SUMMARY.md`
</output>
