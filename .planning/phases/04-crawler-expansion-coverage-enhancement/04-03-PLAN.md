---
phase: 04-crawler-expansion-coverage-enhancement
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - src/crawlers/eventbrite-api-client.ts
  - src/crawlers/eventbrite.ts
  - src/normalization/transformers.ts
  - src/config/env.ts
autonomous: true
requirements: []

user_setup:
  - service: eventbrite
    why: "Event ticketing API integration"
    env_vars:
      - name: EVENTBRITE_API_KEY
        source: "Eventbrite Developer Portal -> Create App -> API Key"
    dashboard_config: []

must_haves:
  truths:
    - "Eventbrite API client successfully authenticates and fetches Stockholm events"
    - "Eventbrite events transform to normalized schema matching database requirements"
    - "Crawler handles pagination and rate limiting gracefully"
  artifacts:
    - path: "src/crawlers/eventbrite-api-client.ts"
      provides: "Eventbrite API client with OAuth authentication and event search"
      exports: ["EventbriteClient"]
      min_lines: 80
    - path: "src/crawlers/eventbrite.ts"
      provides: "Eventbrite crawler with 12-month window and pagination"
      exports: ["crawlEventbrite", "CrawlResult"]
      min_lines: 60
    - path: "src/normalization/transformers.ts"
      provides: "transformEventbriteEvent function"
      exports: ["transformEventbriteEvent"]
    - path: "src/config/env.ts"
      provides: "EVENTBRITE_API_KEY config"
      contains: "EVENTBRITE_API_KEY"
  key_links:
    - from: "src/crawlers/eventbrite.ts"
      to: "src/crawlers/eventbrite-api-client.ts"
      via: "EventbriteClient instantiation with API key"
      pattern: "new EventbriteClient\\(config\\.EVENTBRITE_API_KEY\\)"
    - from: "src/crawlers/eventbrite.ts"
      to: "src/normalization/transformers.ts"
      via: "transformEventbriteEvent call on each event"
      pattern: "transformEventbriteEvent\\(rawEvent\\)"
    - from: "Eventbrite API response"
      to: "database NewEvent schema"
      via: "transformation and validation pipeline"
      pattern: "transformEventbriteEvent.*upsertEvent"
---

<objective>
Integrate Eventbrite API to expand event coverage by fetching Stockholm music events from a major international ticketing platform with strong European presence.

Purpose: Increases comprehensive coverage in parallel with Tickster (per user decision: "APIs early in phase"). Eventbrite has broad venue coverage and is easier to integrate than venue-specific scrapers.
Output: Working Eventbrite API integration with client, crawler, and transformer following Ticketmaster pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-crawler-expansion-coverage-enhancement/04-CONTEXT.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-01-SUMMARY.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-02-SUMMARY.md
@src/crawlers/ticketmaster-api-client.ts
@src/crawlers/ticketmaster.ts
@src/normalization/transformers.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Create Eventbrite API client</name>
  <files>
    src/crawlers/eventbrite-api-client.ts
    src/config/env.ts
  </files>
  <action>
    Create Eventbrite API client following the Ticketmaster client pattern (ticketmaster-api-client.ts).

    Requirements:
    1. Class EventbriteClient with constructor accepting OAuth token (Eventbrite uses OAuth 2.0)
    2. Method searchEvents accepting filters (location=Stockholm, category=Music, date range)
    3. Rate limiting logic (Eventbrite typically allows 1000 requests/hour per organization)
    4. Quota tracking (requests used/total/percentUsed)
    5. Pagination support (Eventbrite uses continuation tokens or page parameters)
    6. Error handling for 401, 403, 429, 500 status codes
    7. Type definitions for Eventbrite API response structure (events have name, start, venue, category, url)

    Eventbrite API specifics:
    - Base URL: https://www.eventbriteapi.com/v3/
    - Auth header: Authorization: Bearer {token}
    - Event search endpoint: /events/search/
    - Location filter: location.address=Stockholm
    - Category filter: categories=103 (Music category ID)

    Add EVENTBRITE_API_KEY to src/config/env.ts validation schema and export.
  </action>
  <verify>
    TypeScript compiles without errors: `npm run build`
    Client instantiation works: `node -e "import('./src/crawlers/eventbrite-api-client.ts').then(m => console.log(new m.EventbriteClient('test-token')))"`
  </verify>
  <done>
    EventbriteClient class exists with searchEvents method, rate limiting, and quota tracking. EVENTBRITE_API_KEY configured in env.ts.
  </done>
</task>

<task type="auto">
  <name>Create Eventbrite crawler and transformer</name>
  <files>
    src/crawlers/eventbrite.ts
    src/normalization/transformers.ts
  </files>
  <action>
    Create Eventbrite crawler following the Ticketmaster crawler pattern (ticketmaster.ts).

    Crawler requirements (src/crawlers/eventbrite.ts):
    1. Export async function crawlEventbrite(): Promise<CrawlResult>
    2. Calculate 12-month rolling window (startDate = now, endDate = now+12months)
    3. Filter for Stockholm location + Music category (category 103)
    4. Pagination loop fetching all pages (handle continuation tokens if Eventbrite uses them)
    5. Progress logging every 10 pages
    6. Call transformEventbriteEvent for normalization
    7. Call upsertEvent for database storage
    8. Return success/failed counts
    9. Graceful error handling (individual event failures don't stop crawl)

    Transformer requirements (add to src/normalization/transformers.ts):
    1. Export function transformEventbriteEvent(rawEvent: any) accepting Eventbrite API event object
    2. Extract: name, artist (from name or description), venue (from venue.name), date (from start.local), genre (from category or default to 'other'), ticketUrl (event.url), price (from ticket_classes if available)
    3. Apply venue normalization (existing venue-mappings.ts) - map venue names to canonical forms
    4. Apply genre normalization (existing genre-mappings.ts)
    5. Validate via EventSchema.safeParse (existing pattern)
    6. Return success/errors structure matching other transformers

    Eventbrite response structure notes:
    - Event object: {name, description, start: {local, utc}, end: {local}, url, venue: {name, address}, category_id}
    - Date format: ISO 8601 (start.local is in local timezone)
    - Venue may be null (online events) - skip those

    Follow existing transformer patterns for consistency. Use 'Eventbrite' as platform value in ticket URLs.
  </action>
  <verify>
    TypeScript compiles: `npm run build`
    Transformer unit test: `node -e "import('./src/normalization/transformers.ts').then(m => console.log(m.transformEventbriteEvent({name: {text: 'Test Concert'}, start: {local: '2026-03-01T20:00:00'}, venue: {name: 'Test Venue'}, url: 'https://eventbrite.com/e/123'})))"`
    Crawler dry run (will fail without API key, but code should load): `node -e "import('./src/crawlers/eventbrite.ts').then(m => console.log('Loaded'))"`
  </verify>
  <done>
    crawlEventbrite function exists and follows established crawler pattern. transformEventbriteEvent function normalizes Eventbrite events to database schema. Both integrate with existing infrastructure (upsertEvent, EventSchema).
  </done>
</task>

</tasks>

<verification>
After user provides EVENTBRITE_API_KEY in .env:
```bash
node -e "import('./src/crawlers/eventbrite.ts').then(m => m.crawlEventbrite())"
```

Should successfully fetch and store Eventbrite events for Stockholm music within 12-month window. Check database for new events with platform='Eventbrite' in ticket URLs.
</verification>

<success_criteria>
1. EventbriteClient authenticates and fetches events from Eventbrite API
2. Crawler handles pagination and fetches all available Stockholm music events
3. Transformer normalizes Eventbrite events to database schema
4. Events save to database via upsertEvent
5. Rate limiting prevents API quota exhaustion (1000 req/hr)
6. Error handling gracefully continues on individual event failures
7. Integration follows existing patterns (Ticketmaster) for maintainability
</success_criteria>

<output>
After completion, create `.planning/phases/04-crawler-expansion-coverage-enhancement/04-03-SUMMARY.md`

Note: User must provide EVENTBRITE_API_KEY before crawler can be tested with live API. Key obtained from https://www.eventbrite.com/platform/api#/introduction/authentication
</output>
