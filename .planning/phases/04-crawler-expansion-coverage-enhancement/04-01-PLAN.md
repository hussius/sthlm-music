---
phase: 04-crawler-expansion-coverage-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crawlers/venues/nalen.ts
  - src/crawlers/venues/kollektivet-livet.ts
  - src/crawlers/venues/venue-configs.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Nalen crawler successfully extracts events from live website"
    - "Kollektivet Livet crawler targets correct URL (stadsgardsterminalen.com/program/)"
    - "Both crawlers return >0 events when run against live sites"
  artifacts:
    - path: "src/crawlers/venues/nalen.ts"
      provides: "Working Nalen crawler with accurate selectors"
      exports: ["crawlNalen"]
    - path: "src/crawlers/venues/kollektivet-livet.ts"
      provides: "Working Kollektivet Livet crawler with corrected URL"
      exports: ["crawlKollektivetLivet"]
    - path: "src/crawlers/venues/venue-configs.ts"
      provides: "Updated configurations for both venues"
      contains: "VENUE_CONFIGS"
  key_links:
    - from: "src/crawlers/venues/nalen.ts"
      to: "src/crawlers/venues/base-venue-crawler.ts"
      via: "VenueConfig import and BaseVenueCrawler instantiation"
      pattern: "new BaseVenueCrawler\\(config\\)"
    - from: "venue selectors"
      to: "actual event data extraction"
      via: "CSS selectors matching live HTML structure"
      pattern: "eventContainer.*eventName.*eventDate"
---

<objective>
Fix broken Nalen and Kollektivet Livet venue crawlers by inspecting live websites, correcting URLs, and refining selectors to match actual HTML structure.

Purpose: Demonstrates reliability by restoring coverage before adding new sources (per user decision: "Fix broken scrapers first"). Kollektivet Livet events are actually hosted at Stadsgårdsterminalen venue.
Output: Two working venue crawlers returning events from live sites.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-crawler-expansion-coverage-enhancement/04-CONTEXT.md
@src/crawlers/venues/base-venue-crawler.ts
@src/crawlers/venues/venue-configs.ts
@src/crawlers/venues/nalen.ts
@src/crawlers/venues/kollektivet-livet.ts
</context>

<tasks>

<task type="auto">
  <name>Fix Nalen crawler selectors</name>
  <files>
    src/crawlers/venues/nalen.ts
    src/crawlers/venues/venue-configs.ts
  </files>
  <action>
    Inspect https://nalen.com/program using Playwright/Cheerio to identify actual HTML structure for events. Update selectors in both nalen.ts config and venue-configs.ts VENUE_CONFIGS array to match real page structure.

    Steps:
    1. Fetch page HTML to identify event container elements
    2. Locate event name, date, and URL selectors
    3. Test if site requires JavaScript (usesJavaScript flag)
    4. Update selectors with accurate CSS paths
    5. Verify by running crawler and checking event extraction

    Current selectors are placeholders (.event, .show, article / .title, h2, h3) - replace with venue-specific accurate selectors.
  </action>
  <verify>
    Run crawler: `node -e "import('./src/crawlers/venues/nalen.ts').then(m => m.crawlNalen())"`
    Should return success count >0 with real event data (not empty or failed).
  </verify>
  <done>
    Nalen crawler extracts events with valid name, date, and URL fields. Success count >0, failed count minimized.
  </done>
</task>

<task type="auto">
  <name>Fix Kollektivet Livet crawler URL and selectors</name>
  <files>
    src/crawlers/venues/kollektivet-livet.ts
    src/crawlers/venues/venue-configs.ts
  </files>
  <action>
    CRITICAL: Update URL from https://kollektivetlivet.se/evenemang to https://stadsgardsterminalen.com/program/ (per planning_context note: "Kollektivet Livet events are at Stadsgårdsterminalen venue").

    Steps:
    1. Change venue URL in both kollektivet-livet.ts config and venue-configs.ts VENUE_CONFIGS array
    2. Fetch page HTML from new URL to identify structure
    3. Update selectors for event container, name, date, URL
    4. Test if site requires JavaScript
    5. Verify crawler extracts events successfully

    Keep venue name as "Kollektivet Livet" in output (normalized venue name) but crawl from stadsgardsterminalen.com URL.
  </action>
  <verify>
    Run crawler: `node -e "import('./src/crawlers/venues/kollektivet-livet.ts').then(m => m.crawlKollektivetLivet())"`
    Should return success count >0 from stadsgardsterminalen.com URL.
  </verify>
  <done>
    Kollektivet Livet crawler targets https://stadsgardsterminalen.com/program/ and successfully extracts events. Success count >0, events normalized with venue="Kollektivet Livet".
  </done>
</task>

</tasks>

<verification>
Run both crawlers and confirm:
- Nalen: `node -e "import('./src/crawlers/venues/nalen.ts').then(m => m.crawlNalen())"`
- Kollektivet Livet: `node -e "import('./src/crawlers/venues/kollektivet-livet.ts').then(m => m.crawlKollektivetLivet())"`

Both should report success count >0 with real event data.
</verification>

<success_criteria>
1. Nalen crawler successfully extracts events from https://nalen.com/program
2. Kollektivet Livet crawler successfully extracts events from https://stadsgardsterminalen.com/program/
3. Both crawlers have accurate selectors matching live HTML structure
4. Test runs show success count >0 for both venues
5. Events saved to database with valid name, date, venue, and URL fields
</success_criteria>

<output>
After completion, create `.planning/phases/04-crawler-expansion-coverage-enhancement/04-01-SUMMARY.md`
</output>
