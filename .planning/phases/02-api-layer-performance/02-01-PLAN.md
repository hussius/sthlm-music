---
phase: 02-api-layer-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/server.ts
  - src/api/routes/health.ts
  - src/api/middleware/response-time.ts
  - src/index.ts
autonomous: true
requirements: [PERF-01]

must_haves:
  truths:
    - "HTTP server starts and listens on configured port"
    - "GET /health returns 200 with system status"
    - "Response time is measured and logged for slow requests (>200ms)"
    - "X-Response-Time header is present in all responses"
  artifacts:
    - path: "src/server.ts"
      provides: "Fastify server initialization with Zod validation"
      exports: ["buildServer"]
      min_lines: 30
    - path: "src/api/routes/health.ts"
      provides: "Health check endpoint"
      exports: ["healthRoutes"]
      min_lines: 10
    - path: "src/api/middleware/response-time.ts"
      provides: "Response time tracking middleware"
      exports: ["responseTimePlugin"]
      min_lines: 20
  key_links:
    - from: "src/index.ts"
      to: "src/server.ts"
      via: "buildServer import and call"
      pattern: "import.*buildServer.*from.*server"
    - from: "src/server.ts"
      to: "src/api/middleware/response-time.ts"
      via: "plugin registration"
      pattern: "register.*responseTimePlugin"
    - from: "src/server.ts"
      to: "src/api/routes/health.ts"
      via: "route registration"
      pattern: "register.*healthRoutes"
---

<objective>
Create Fastify API server foundation with response time monitoring and health check endpoint.

Purpose: Establish the HTTP server infrastructure for Phase 2 API layer with built-in performance monitoring to validate sub-200ms response time requirement.

Output: Working Fastify server with health endpoint and response time tracking middleware, ready for events API routes in next plan.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-layer-performance/02-RESEARCH.md
@src/db/schema.ts
@src/db/client.ts
@src/config/env.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fastify dependencies and create server structure</name>
  <files>
    package.json
    src/server.ts
    src/api/routes/health.ts
  </files>
  <action>
Install Fastify and supporting packages:
```bash
npm install fastify@^5 fastify-type-provider-zod@^2 @fastify/cors@^10 @fastify/helmet@^12
```

Create src/server.ts with buildServer() function that:
- Initializes Fastify with logger (level from process.env.LOG_LEVEL or 'info')
- Registers @fastify/helmet for security headers
- Registers @fastify/cors with origin from process.env.CORS_ORIGIN or 'http://localhost:3000'
- Sets up Zod validation using fastify-type-provider-zod (setValidatorCompiler, setSerializerCompiler)
- Returns configured Fastify instance
- Use ZodTypeProvider from fastify-type-provider-zod
- Follow research example pattern from 02-RESEARCH.md section "Fastify Server Initialization"

Create src/api/routes/health.ts with healthRoutes plugin:
- Define GET /health endpoint that returns { status: 'ok', timestamp: new Date().toISOString() }
- Export as Fastify plugin function
- Use async function signature: async function healthRoutes(fastify: FastifyInstance)
  </action>
  <verify>
Run TypeScript compilation: npm run build
Verify compiled output exists in dist/
Check that fastify, fastify-type-provider-zod, @fastify/cors, @fastify/helmet appear in package.json dependencies
  </verify>
  <done>
- Fastify 5.x and supporting packages installed in package.json
- src/server.ts exports buildServer() function with security and CORS configured
- src/api/routes/health.ts exports healthRoutes plugin
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add response time monitoring middleware</name>
  <files>
    src/api/middleware/response-time.ts
    src/server.ts
  </files>
  <action>
Create src/api/middleware/response-time.ts following the pattern from 02-RESEARCH.md section "Response Time Monitoring Middleware":

- Import performance from 'perf_hooks'
- Export responseTimePlugin as Fastify plugin
- Add onRequest hook to capture start time: request.startTime = performance.now()
- Add onResponse hook to:
  - Calculate duration: performance.now() - request.startTime
  - Log warning if duration > 200ms (includes method, url, duration, statusCode)
  - Add X-Response-Time header with formatted duration (e.g., "123.45ms")
- Use fastify.log.warn() for slow requests to match Fastify's logger format

Update src/server.ts:
- Import responseTimePlugin
- Register plugin after helmet/cors but before routes: await fastify.register(responseTimePlugin)
  </action>
  <verify>
Run TypeScript compilation: npm run build
Check that src/api/middleware/response-time.ts exists and exports responseTimePlugin
Check that src/server.ts registers responseTimePlugin
  </verify>
  <done>
- Response time tracking middleware logs slow requests (>200ms)
- X-Response-Time header added to all responses
- Middleware registered in Fastify server before routes
  </done>
</task>

<task type="auto">
  <name>Task 3: Update entry point to start Fastify server</name>
  <files>
    src/index.ts
  </files>
  <action>
Update src/index.ts to start the Fastify server:

- Import buildServer from './server.js' (note .js extension for ES modules)
- Import env from './config/env.js'
- Replace or update existing database connection test with server startup
- Call buildServer() to get Fastify instance
- Start server with await server.listen({ port: env.PORT || 3000, host: '0.0.0.0' })
- Log success message with listening address
- Wrap in try/catch to log errors and exit with process.exit(1) on failure
- Use server.log.info() for logging (Fastify's built-in logger)

Keep existing database client import for use in future repository integration.
  </action>
  <verify>
Run TypeScript compilation: npm run build
Start server: npm run dev
Verify console shows "Server listening at http://0.0.0.0:3000" or similar
Test health endpoint: curl http://localhost:3000/health
Verify response is JSON: {"status":"ok","timestamp":"..."}
Verify X-Response-Time header exists in response
Stop server with Ctrl+C
  </verify>
  <done>
- src/index.ts starts Fastify server on configured port
- Server successfully starts and logs listening address
- GET /health returns 200 with status and timestamp
- X-Response-Time header present in health check response
- Server can be stopped gracefully
  </done>
</task>

</tasks>

<verification>
1. Run npm run build - TypeScript compiles without errors
2. Run npm run dev - server starts and shows listening message
3. Test health endpoint: curl -i http://localhost:3000/health
   - Verify 200 status code
   - Verify JSON response with status and timestamp
   - Verify X-Response-Time header exists
4. Check logs for response time measurement
5. Verify no errors in console output
</verification>

<success_criteria>
- Fastify 5.x server starts successfully on port 3000
- GET /health returns 200 with { status: 'ok', timestamp: string }
- X-Response-Time header present in all responses
- Slow requests (>200ms) trigger warning logs
- Server foundation ready for events API routes (02-03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-layer-performance/02-01-SUMMARY.md` using the summary template.
</output>
