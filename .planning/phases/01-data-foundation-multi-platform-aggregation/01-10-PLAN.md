---
phase: 01-data-foundation-multi-platform-aggregation
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scheduling/jobs.ts
  - src/scheduling/monitoring.ts
autonomous: true
requirements: [DATA-05]
gap_closure: true

must_haves:
  truths:
    - "Scraper failures trigger alerts within 5 minutes of first failure"
    - "Alert system notifies immediately while retries continue in background"
    - "Failed jobs are retried without blocking alert delivery"
  artifacts:
    - path: "src/scheduling/jobs.ts"
      provides: "Retry configuration with reduced backoff timing"
      contains: "backoff.*delay.*30000"
    - path: "src/scheduling/monitoring.ts"
      provides: "Immediate alert on first failure"
      contains: "attemptsMade.*1"
  key_links:
    - from: "src/scheduling/monitoring.ts"
      to: "src/scheduling/jobs.ts"
      via: "queueEvents listens to job failures"
      pattern: "queueEvents.*on.*failed"
---

<objective>
Reduce scraper failure alert timing from 7+ minutes to under 5 minutes to meet Success Criterion 5.

Purpose: Close Gap 2 from verification - ensure fast detection of crawl failures to prevent multi-day data gaps
Output: Alert fires within 5 minutes of failure, retry backoff reduced, monitoring fires on first failure
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-VERIFICATION.md
@src/scheduling/jobs.ts
@src/scheduling/monitoring.ts
</context>

<tasks>

<task type="auto">
  <name>Reduce retry backoff and send immediate alerts on first failure</name>
  <files>
    src/scheduling/jobs.ts
    src/scheduling/monitoring.ts
  </files>
  <action>
    Update job retry strategy and monitoring to meet 5-minute alert requirement.

    **Problem:** Current timing = 60s + 120s + 240s (exponential backoff) = 7 minutes minimum before alert
    **Solution:** Immediate alert on first failure + reduced backoff for retries = alert within 5 seconds

    **1. src/scheduling/jobs.ts (lines 20-32):**
    Change retry backoff from 60s to 30s initial with 2 max attempts:
    ```typescript
    defaultJobOptions: {
      attempts: 2,  // Reduced from 3 to 2
      backoff: {
        type: 'exponential',
        delay: 30000  // Reduced from 60000 to 30000 (30 seconds)
      },
      removeOnComplete: {
        age: 86400
      },
      removeOnFail: {
        age: 604800
      }
    }
    ```
    **Timing:** First failure → retry at 30s → retry at 60s = 90s total (under 5 min requirement)

    **2. src/scheduling/monitoring.ts (lines 84-112):**
    Change alert trigger from "attemptsMade >= 3" to "attemptsMade >= 1" (first failure):
    ```typescript
    queueEvents.on('failed', async ({ jobId, failedReason }) => {
      const job = await crawlQueue.getJob(jobId);
      const attempts = job?.attemptsMade || 0;

      console.error(`JOB FAILED: ${job?.name} (attempt ${attempts}/2)`);
      console.error(`Reason: ${failedReason}`);

      // Send alert immediately on first failure (don't wait for retries)
      if (attempts >= 1) {
        await sendAlert({
          type: 'job_failure',
          jobName: job?.name || 'unknown',
          jobId,
          reason: failedReason,
          timestamp: new Date(),
          attemptsRemaining: 2 - attempts  // Include retry info
        });
      }
    });
    ```

    **Why this works:**
    - Alert sent immediately on first failure (within seconds)
    - Job continues retrying in background (30s, 60s backoff)
    - Humans notified early while system recovers automatically
    - If transient failure → retry succeeds, humans already aware
    - If persistent failure → humans have head start on investigation

    **3. Update Alert interface (monitoring.ts line ~117):**
    Add `attemptsRemaining` field to alert:
    ```typescript
    interface Alert {
      type: 'job_failure' | 'health_check_failure';
      jobName: string;
      jobId?: string;
      reason?: string;
      timestamp: Date;
      attemptsRemaining?: number;  // NEW: How many retries left
    }
    ```

    **4. Update sendAlert formatting (monitoring.ts line ~133):**
    Include retry information in alert message:
    ```typescript
    console.error('========================================');
    console.error('ALERT: Job Failure');
    console.error(`Job: ${alert.jobName}`);
    console.error(`Reason: ${alert.reason}`);
    console.error(`Time: ${alert.timestamp.toISOString()}`);
    console.error(`Retries remaining: ${alert.attemptsRemaining || 0}`);
    console.error('Action: Monitoring for automatic retry...');
    console.error('========================================');
    ```

    **DO NOT** add separate health check job - adds complexity without benefit. Immediate alerting solves the timing problem directly.
  </action>
  <verify>
    - `npm run build` compiles without type errors
    - jobs.ts defaultJobOptions.attempts = 2 (not 3)
    - jobs.ts backoff.delay = 30000 (not 60000)
    - monitoring.ts triggers alert when attemptsMade >= 1 (not >= 3)
    - Alert interface includes attemptsRemaining field
    - sendAlert displays retry information
  </verify>
  <done>
    - Retry backoff reduced to 30s initial (from 60s)
    - Max attempts reduced to 2 (from 3)
    - Alerts fire on first failure (attemptsMade >= 1)
    - Alert includes remaining retry count
    - Total retry time: 90 seconds (30s + 60s)
    - Alert timing: <5 seconds (immediate on failure)
    - TypeScript compilation successful
  </done>
</task>

</tasks>

<verification>
## Manual Verification

Simulate job failure to verify alert timing:

1. **Temporarily break AXS crawler:**
   ```typescript
   // In src/crawlers/axs.ts, change URL to invalid
   const crawler = new PlaywrightCrawler({
     async requestHandler({ page, request }) {
       throw new Error('TEST FAILURE - simulating network timeout');
     }
   });
   ```

2. **Trigger job manually:**
   ```bash
   tsx -e "import { crawlQueue } from './src/scheduling/jobs.js'; await crawlQueue.add('axs-crawl', { source: 'axs' });"
   ```

3. **Time alert appearance:**
   - Start timer when job is added
   - Watch console output for "ALERT: Job Failure" message
   - Verify alert appears within 5 seconds of failure

4. **Expected behavior:**
   - Immediate alert: "JOB FAILED: axs-crawl (attempt 1/2)"
   - Alert shows: "Retries remaining: 1"
   - After 30s: Second attempt fails, alert: "attempt 2/2"
   - After 60s: Final retry (if enabled), alert: "attempt 2/2, Retries remaining: 0"

5. **Restore crawler:**
   Remove test failure code from axs.ts

## Automated Checks

- `npm run build` compiles successfully
- No TypeScript errors in scheduling files
- jobs.ts has attempts: 2 and delay: 30000
- monitoring.ts checks attemptsMade >= 1
</verification>

<success_criteria>
- ✅ Retry backoff reduced to 30s initial delay
- ✅ Max attempts reduced to 2
- ✅ Alerts fire immediately on first failure (attemptsMade >= 1)
- ✅ Alert interface includes attemptsRemaining field
- ✅ Alert message displays retry information
- ✅ Total retry time under 2 minutes (30s + 60s = 90s)
- ✅ Alert timing under 5 seconds (immediate on failure)
- ✅ Manual test shows alert appears within 5 seconds
- ✅ Gap 2 from verification report is closed
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation-multi-platform-aggregation/01-10-SUMMARY.md` documenting:
- Retry timing changes (60s → 30s, 3 attempts → 2)
- Alert trigger change (3rd attempt → 1st attempt)
- Alert timing improvement (7+ min → <5 sec)
- Manual testing procedure for verification
- Rationale for immediate alerting vs health checks
</output>
