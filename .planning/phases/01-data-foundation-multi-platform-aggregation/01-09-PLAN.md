---
phase: 01-data-foundation-multi-platform-aggregation
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - src/deduplication/deduplicator.ts
  - src/deduplication/exact-match.ts
  - src/repositories/event-repository.ts
autonomous: true
requirements: [DATA-05]
gap_closure: true

must_haves:
  truths:
    - "When duplicate event detected, system stores ticket URLs from all sources"
    - "User can access multiple ticket purchase platforms for same event"
    - "Database preserves first source as primary while tracking all sources"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "Events table with ticketSources JSONB array field"
      contains: "ticketSources"
    - path: "src/deduplication/deduplicator.ts"
      provides: "Ticket URL merging logic in deduplicateAndSave"
      min_lines: 180
    - path: "src/deduplication/exact-match.ts"
      provides: "mergeEventData with ticket source merging"
      min_lines: 90
    - path: "src/repositories/event-repository.ts"
      provides: "upsertEvent with ticket source array handling"
      min_lines: 120
  key_links:
    - from: "src/deduplication/deduplicator.ts"
      to: "src/deduplication/exact-match.ts"
      via: "checkExactMatch returns event with merged ticket sources"
      pattern: "mergeEventData.*ticketSources"
    - from: "src/repositories/event-repository.ts"
      to: "src/db/schema.ts"
      via: "upsertEvent merges ticketSources on conflict"
      pattern: "ticketSources.*sql.*array_append"
---

<objective>
Implement ticket URL merging across duplicate events to provide users with all ticket purchase options.

Purpose: Close Gap 1 from verification - enable users to see ticket links from ALL platforms (Ticketmaster, AXS, DICE) when same event appears on multiple sources
Output: Database schema updated, deduplication pipeline merges ticket sources, events store multiple ticket URLs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-VERIFICATION.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-01-SUMMARY.md
@.planning/phases/01-data-foundation-multi-platform-aggregation/01-07-SUMMARY.md
@src/db/schema.ts
@src/deduplication/deduplicator.ts
@src/deduplication/exact-match.ts
@src/repositories/event-repository.ts
</context>

<tasks>

<task type="auto">
  <name>Add ticketSources array to events schema</name>
  <files>src/db/schema.ts</files>
  <action>
    Replace single `ticketUrl` text field with `ticketSources` JSONB array field in events table.

    Schema change:
    - Remove: `ticketUrl: text('ticket_url').notNull()`
    - Add: `ticketSources: jsonb('ticket_sources').notNull()` with structure:
      ```typescript
      {
        platform: string;  // "ticketmaster", "axs", "dice", "venue-direct"
        url: string;       // Ticket purchase URL
        addedAt: string;   // ISO timestamp when source was added
      }[]
      ```
    - Add type export: `export type TicketSource = { platform: string; url: string; addedAt: string; }`
    - Update Event and NewEvent types to reflect ticketSources field

    Migration:
    - Generate migration: `npm run db:generate`
    - Apply migration: `npm run db:push`
    - Migration will convert existing ticketUrl values to ticketSources array with single entry

    **Why JSONB array instead of separate table:**
    - Simpler queries (no JOIN needed)
    - Typical event has 1-3 ticket sources (small array)
    - PostgreSQL JSONB is indexed and queryable
    - Avoids N+1 query problem for API responses
  </action>
  <verify>
    - `npm run db:generate` creates new migration file
    - `npm run db:push` applies migration successfully
    - `npm run build` compiles without type errors
    - Schema exports TicketSource type definition
  </verify>
  <done>
    - events table has ticketSources JSONB field (no ticketUrl field)
    - TicketSource type exported from schema.ts
    - Migration applied to database
    - TypeScript compilation successful
  </done>
</task>

<task type="auto">
  <name>Update deduplication pipeline to merge ticket sources</name>
  <files>
    src/deduplication/exact-match.ts
    src/deduplication/deduplicator.ts
    src/repositories/event-repository.ts
  </files>
  <action>
    Update three files to handle ticket source merging:

    **1. src/deduplication/exact-match.ts:**
    - Update `mergeEventData` function (currently line ~70-80)
    - When merging, combine ticketSources arrays from both events
    - Deduplicate by platform (same platform = keep existing, different platform = add new)
    - Return event with merged ticketSources array
    ```typescript
    // Merge ticket sources (deduplicate by platform)
    const existingPlatforms = new Set(existing.ticketSources.map(s => s.platform));
    const newSources = incoming.ticketSources.filter(s => !existingPlatforms.has(s.platform));
    merged.ticketSources = [...existing.ticketSources, ...newSources];
    ```

    **2. src/deduplication/deduplicator.ts:**
    - Remove TODO comment at line 133-136
    - Replace `throw new Error('Duplicate event...')` with ticket source merge logic
    - When duplicate detected (case 'duplicate'):
      1. Fetch existing event by `result.existingEventId`
      2. Merge new ticket source into existing event's ticketSources array
      3. Call `upsertEvent` with merged event to update database
      4. Return updated event (not throw error)
    ```typescript
    case 'duplicate':
      const existing = await getEventById(result.existingEventId);
      const merged = mergeTicketSources(existing, event);
      const updated = await upsertEvent(merged);
      console.log(`Merged ticket source into existing event: ${updated.name}`);
      return updated;
    ```

    **3. src/repositories/event-repository.ts:**
    - Update `upsertEvent` function to handle ticketSources array merging on conflict
    - Change conflict resolution from DO UPDATE SET to merge arrays:
    ```sql
    ON CONFLICT (venue, date) DO UPDATE SET
      ticket_sources = events.ticket_sources || EXCLUDED.ticket_sources,
      updated_at = now()
    ```
    - Use PostgreSQL `||` operator to concatenate JSONB arrays
    - Add deduplication in SQL: `array(SELECT DISTINCT jsonb_array_elements(...))`
    - Create helper function `getEventById` for fetching by ID (used by deduplicator)
  </action>
  <verify>
    - `npm run build` compiles without type errors
    - No TODO comments remain in deduplicator.ts line 133-136 area
    - mergeEventData function handles ticketSources arrays
    - deduplicateAndSave returns event (not throw) on duplicate case
    - upsertEvent uses JSONB array merge on conflict
  </verify>
  <done>
    - Exact match merges ticket sources from both events
    - Deduplicator saves merged ticket sources (no error thrown)
    - Repository upsertEvent merges arrays on conflict
    - getEventById helper function exists for duplicate case
    - TypeScript compilation successful
  </done>
</task>

</tasks>

<verification>
## Manual Verification

After implementation, verify ticket URL merging works:

1. **Insert test event from Ticketmaster:**
   ```typescript
   await upsertEvent({
     name: "Test Concert",
     artist: "Test Artist",
     venue: "Debaser Strand",
     date: new Date("2026-06-15T19:00:00Z"),
     genre: "rock",
     ticketSources: [{ platform: "ticketmaster", url: "https://tm.se/test1", addedAt: new Date().toISOString() }],
     sourceId: "tm-123",
     sourcePlatform: "ticketmaster"
   });
   ```

2. **Insert duplicate from AXS:**
   ```typescript
   await deduplicateAndSave({
     name: "Test Concert",
     artist: "Test Artist",
     venue: "Debaser Strand",
     date: new Date("2026-06-15T19:00:00Z"),
     genre: "rock",
     ticketSources: [{ platform: "axs", url: "https://axs.com/test2", addedAt: new Date().toISOString() }],
     sourceId: "axs-456",
     sourcePlatform: "axs"
   });
   ```

3. **Query database:**
   ```sql
   SELECT name, venue, date, ticket_sources FROM events WHERE name = 'Test Concert';
   ```

4. **Expected result:**
   - Single event row (not duplicate)
   - ticketSources array has 2 entries (Ticketmaster AND AXS)
   - Both URLs preserved

## Automated Checks

- `npm run build` compiles successfully
- No TypeScript errors in deduplication files
- Database migration applied (ticketSources field exists)
- Schema exports TicketSource type
</verification>

<success_criteria>
- ✅ events table has ticketSources JSONB array field (replaces ticketUrl)
- ✅ TicketSource type exported from schema.ts
- ✅ Database migration applied successfully
- ✅ mergeEventData combines ticketSources arrays
- ✅ deduplicateAndSave merges ticket sources on duplicate (no error thrown)
- ✅ upsertEvent merges arrays using PostgreSQL JSONB operators
- ✅ getEventById helper function exists
- ✅ Manual test shows single event with multiple ticket sources
- ✅ Gap 1 from verification report is closed
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation-multi-platform-aggregation/01-09-SUMMARY.md` documenting:
- Schema changes (ticketUrl → ticketSources)
- Migration details
- Deduplication pipeline changes
- Example ticket source merging behavior
- Integration impact on crawlers
</output>
